function GraphEditor(t,e,a=["Новый узел"],i,n,d){function s(t,e,a){let i;e=e||window;let n=t.split(".");a=a||n[0],n.forEach(t=>{if(void 0===(i=e[t]))throw`Graph editor error: ${a} library must be included.`;e=i})}s("jQuery"),s("vis.Network",!1,"Vis.js Network"),s("vis.DataSet",!1,"Vis.js DataSet"),s("transition",jQuery(),"Semantic UI"),s("modal",jQuery(),"Semantic UI"),s("dropdown",jQuery(),"Semantic UI");let o={classes:Object.freeze({node:"Узел",edge:"Ребро"}),container:jQuery(t).first(),save:()=>(function(t,e,a){let i=document.createElement("a"),n=new Blob([t],{type:a});i.href=URL.createObjectURL(n),i.download=e,i.click()})(o.serialize(),"graph.json","application/json"),addNode:(t,e=0,a={})=>{o.graph.storePositions();let i={x:0,y:0},n=o.data[o.classes.node].get();return console.log("type",e),n.length&&(i.x=n.map(t=>t.x).reduce((t,e)=>t+e)/n.length,i.y=n.map(t=>t.y).reduce((t,e)=>t+e)/n.length,i.x+=100*Math.random()-50,i.y+=100*Math.random()-50),setTimeout(()=>p(),1),o.data[o.classes.node].add(Object.assign({},i,o.types[o.classes.node][e].template,{id:t,type:e},a))[0]},addEdge:(t,e,a,i=0,n={})=>o.data[o.classes.edge].add(Object.assign({},o.types[o.classes.edge][i].template,{id:a,type:i,from:t,to:e},n))[0],removeNode:t=>o.data[o.classes.node].remove(t),removeEdge:t=>o.data[o.classes.edge].remove(t)};if(o.data={[o.classes.node]:new vis.DataSet(n),[o.classes.edge]:new vis.DataSet(d)},o.types={[o.classes.node]:e&&e.length?e:GraphEditor.CreateStyles(GraphEditor.CreateType("Эллипс","Синие эллипсы","blue",{color:"#8dd0f8",shape:"ellipse"}),GraphEditor.CreateType("Прямоугольник","Зелёные прямоугольники","green",{color:"#82ec93",shape:"box"})),[o.classes.edge]:i&&i.length?i:GraphEditor.CreateStyles(GraphEditor.CreateType("Сплошное","Без штриховки","hidden",{arrows:"to",dashes:!1,color:{inherit:"both"}}),GraphEditor.CreateType("Штрихованное","Равномерная штриховка","hidden",{arrows:"to",dashes:!0,color:{inherit:"both"}}))},!o.container.length)throw"Graph editor error: can not find container.";function l(t,e,i){let n,d=o.types[t].map(t=>`<div class="item" data-value="${t.id}" data-text='<div class="ui ${t.color} empty circular label"></div> ${t.name}'><div class="ui ${t.color} empty circular label"></div> ${t.name} <span class="description">${t.description}</span></div>`);if(t===o.classes.edge)n='<div class="label-text" contenteditable="true" data-placeholder="Введите название">Название</div>';else{n=`<div class="ui search selection dropdown"><input type="hidden" value="0" data-property="title"><i class="dropdown icon"></i><div class="label-text text">Название</div><div class="menu">${a.map(t=>`<div class="item" data-value="${t}" data-text='${t}'>${t}</span></div>`).join("")}</div></div>`}let s=jQuery(`<div class="class-editor"><div class="ui raised card"><div class="content"><div class="label">${n}</div><div class="meta">${t}</div><div class="description"><p contenteditable="true" data-placeholder="Введите описание">Описание</p><div class="ui inline labeled dropdown"><input type="hidden" value="0" data-property="type"><div class="text">${jQuery(d[0]).find(".item").data("text")}</div><i class="dropdown icon"></i><div class="menu">${d.join("")}</div></div></div></div><div class="ui bottom attached buttons"><button class="delete ui grey button">Удалить</button><div class="or" data-text="?"></div><button class="save ui positive button">Сохранить</button></div></div></div>`),l=s.find(".content>.label .label-text");s.find(".content>.label .dropdown").dropdown();let c=s.find('.content p[contenteditable="true"]'),p=s.find(".content>.description .dropdown").dropdown();return s.load=function(t){return s.object=t,l.text(t.label||""),c.text(t.title||""),p.dropdown("set exactly",""+(t.type||"0")),s.transition(s.is(":visible")?"jiggle":"fade right"),s},s.hide=function(){s.is(":visible")&&s.transition("fade right")},s.find(".save.button").click(function(){r(s.object,"label",l.text().trim()),r(s.object,"title",c.text()),s.object.type=p.dropdown("get value")[0],s.hide(),e(t,s.object)}),s.find(".delete.button").click(function(){s.hide(),i(t,s.object)}),s}function r(t,e,a){return!a&&t.hasOwnProperty(e)?delete t[e]:t[e]=a,t}function c(t,e,a){o.graph.storePositions();let i=o.data[t].get(e.id);return e=Object.assign(e,o.types[t][1*e.type].template,i&&i.hasOwnProperty("x")?{x:i.x,y:i.y}:{}),a&&(o.data[t].remove(e.id),o.data[t].add(e)),e}function p(){o.graph.stabilize(),u()}function u(){o.graph.storePositions();let t,e,a=o.data[o.classes.node].get();a.length?(t=a.map(t=>t.x).reduce((t,e)=>t+e)/a.length,e=a.map(t=>t.y).reduce((t,e)=>t+e)/a.length):t=e=0,o.graph.moveTo({position:{x:t,y:e},scale:2,animation:!0})}function v(t){Object.getOwnPropertyNames(h).filter(e=>e!==t).forEach(t=>h[t].hide())}let h=Object.fromEntries(Object.values(o.classes).map(t=>[t,l(t,function(t,e){o.graph.disableEditMode(),c(t,e,!0)},function(t,e){o.graph.disableEditMode(),o.data[t].remove(e.id)})])),f=function(t,e){let a,i,n=jQuery('<div class="pane"></div>'),d=0;return o.graph=new vis.Network(n[0],{nodes:o.data[o.classes.node],edges:o.data[o.classes.edge]},{manipulation:{enabled:!1,editEdge:function(t,a){t.from===t.to?a(null):(setTimeout(()=>{o.graph.disableEditMode()},1),d=0,a(e(o.classes.edge,t)))},addNode:function(t,a){t.type="0",delete t.label,setTimeout(()=>{o.graph.disableEditMode()},1),a(e(o.classes.node,t))},addEdge:function(t,a){t.type="0",delete t.label,delete t.title,setTimeout(()=>{o.graph.disableEditMode()},1),t.from!==t.to&&a(e(o.classes.edge,t))}},locale:"ru",physics:{stabilization:{fit:!1}}}),o.graph.addEventListener("select",function(n){n.nodes.length?(a=o.data[o.classes.node].get(n.nodes[0]),i=o.classes.node,t(i,a)):1===n.edges.length?(o.graph.editEdgeMode(),a=o.data[o.classes.edge].get(n.edges[0]),i=o.classes.edge,d=1,t(i,a)):a&&i&&e(i,a)}),n.find("canvas").click(function(){1===d?d=2:2===d&&(d=0,o.graph.disableEditMode(),o.graph.unselectAll())}),o.serialize=function(){return o.graph.storePositions(),JSON.stringify(Object.fromEntries(Object.entries(o.classes).map(([t,e])=>[t,o.data[e].get()])))},o.deserialize=function(t){let e=JSON.parse(t);Object.entries(o.classes).forEach(([t,a])=>{o.data[a].clear(),e[t].forEach(t=>o.data[a].add(t))}),p()},n}(function(t,e){v(t),h[t].load(e)},function(t,e){return v(),c(t,e,!1)}),g=function(t){let e,a=jQuery('<div class="ui mini modal"><div class="header">Загрузить граф из файла</div><div class="content"><div class="file ui left labeled button"><a class="ui basic label">Файл не выбран</a><div class="ui icon button"><i class="file code icon"></i>Выбрать файл</div></div><input type="file" autocomplete="off" accept="application/json" hidden><div class="ui hidden negative message"><p>Невозможно загрузить файл. Проверьте правильность пути, формат или укажите другой файл.</p></div></div><div class="actions"><div class="ui negative cancel button">Отмена</div><div class="ui positive ok button">Загрузить</div></div></div>');function i(t){t||t!==s.is(":visible")||s.transition("fade up"),t?o.addClass("loading"):o.removeClass("loading")}let n=a.find('input[type="file"]'),d=a.find(".content .file.button .label"),s=a.find(".negative.message"),o=a.find(".actions .ok.button");return a.find(".content .file.button").click(()=>n.trigger("click")),n.change(function(){e=!(!this.files||!this.files[0])&&this.files[0],d.text(e&&e.name||"Выбрать файл")}),a.initialize=function(){a.modal({transition:"horizontal flip",blurring:!0,onApprove:function(){if(e){i(!0);let n=new FileReader;n.onerror=n.onabort=(()=>i(!1)),n.onload=function(e){try{t(e.target.result),o.removeClass("loading"),a.modal("hide")}catch(e){i(!1)}},n.readAsText(e)}else i(!1);return!1}})},a.show=(()=>a.modal("show")),a}(o.deserialize);o.load=(()=>g.show());let b=function(...t){let e=t.map(t=>jQuery(`<a class="item" data-name="${t.name}"><i class="${t.icon} icon"></i>${t.label}</a>`).click(t.click)),a=jQuery('<div class="graph-menu"><div class="ui compact labeled icon raised menu"></div></div>');return a.find(".menu").append(...e),a}({name:"addNode",label:"Новый узел",icon:"plus square",click:function(){v(),o.graph.addNodeMode()}},{name:"addEdge",label:"Новое ребро",icon:"long arrow alternate right",click:function(){v(),o.graph.addEdgeMode()}},{name:"fitZoom",label:"Выровнять",icon:"expand",click:u},{name:"save",label:"Сохранить",icon:"save",click:o.save},{name:"load",label:"Загрузить",icon:"folder open",click:o.load});return o.container.html(jQuery('<div class="graph-editor"></div>').append(f,g,b,...Object.values(h))),g.initialize(),u(),o}GraphEditor.CreateType=function(t,e,a,i){return{template:i,name:t,color:a,description:e}},GraphEditor.CreateStyles=function(...t){return t.map(function(t,e){return t.template.type=t.id=""+e,t})};